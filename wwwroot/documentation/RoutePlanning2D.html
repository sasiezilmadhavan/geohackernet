<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <link rel="icon" href="favicon.ico" />
    <title>Route Planning 2D - Tutorial</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./resources/bootstrap.min.css">
    <link rel="stylesheet" href="./resources/jquery-ui-1.10.3.custom.css">
    <link rel="stylesheet" href="./resources/font-awesome.min.css">
    <link rel="stylesheet" href="./resources/prism.css">
    <link rel="stylesheet" href="./resources/demobrowser.css">
    <link rel="stylesheet" href="./resources/altus.css">
    <link rel="stylesheet" href="./resources/docs.css">
    <script src="./resources/jquery-1.9.1.min.js" type="text/javascript"></script>
    <script src="./resources/jquery-migrate-1.2.1.min.js" type="text/javascript"></script>
    <script src="./resources/bootstrap.js" type="text/javascript"></script>
    <script src="./resources/holder.js" type="text/javascript"></script>
    <script src="./resources/jquery-ui-1.10.3.custom.min.js" type="text/javascript"></script>
    <script src="./resources/prism.js" type="text/javascript"></script>
    <script src="./resources/demo.js" type="text/javascript"></script>
  </head>

  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">

          <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="RoutePlanning2D.html">Altus Platform - Route Planning 2D - Tutorial</a>
        </div>

        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li id="Documentation"><a href="http://releases.ba3.us/latest/">Home</a></li>
            <li id="iOS"><a href="../../../iOS/AltusMappingEngine/documentation/index.html">iOS</a></li>
            <li id="Android"><a href="../../../Android/AltusMappingEngine/documentation/index.html">Android</a></li>
            <li id="Windows"><a href="../../../Windows/AltusMappingEngine/documentation/index.html">Windows</a></li>
            <li id="Web"><a href="../../../Web/AltusMappingEngine/documentation/index.html">Web</a></li>
            <li id="Server"><a href="../../../Unix/AltusServer/documentation/index.html">Server</a></li>
            <li><a href="http://www.ba3.us">BA3</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-3 col-md-2 sidebar">
                <ul id="sidebar_list" class="nav nav-sidebar">
                </ul>
            </div>
            <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">

    <h2 id="route-planning-2d">Route Planning 2D</h2>
<p>This sample demonstrates a route planning scenario with:</p>
<ul>
<li>A route composed of data from a json file.</li>
<li>Plotting a 2D dynamic vector line to represent the route</li>
<li>Clustered marker labels to represent each way point</li>
</ul>
<div class="figure">
<img src="Images/Documentation/Images/RoutePlanning2D.png" alt="Route Planning 2D" /><p class="caption">Route Planning 2D</p>
</div>
<p>When the user clicks on the route or a waypoint:</p>
<ul>
<li>Panning and zooming are disabled</li>
<li>The mouse movement is translated into updating and redrawing the route.</li>
<li>When the user lets go of the mouse button, the labels are reclustered.</li>
</ul>
<h4 id="javascript-source">JavaScript Source</h4>

<pre><code class=language-javascript>//RoutePlanning2D.js
//Globals that control this scenario.
var movingPointIndex; //The index of the current moving route point
var pointWasMoved; //Indicates if a newly inserted route point was actually moved
var labelLayerName = &quot;RouteLabels&quot;; //Name of marker layer
var fontSize = 12; //Font size of labels
var maxLevel = 11; //Maximum level to cluster labels to
var clusterDistance = 20; //Cluster distance for labels
var routeData; //Will contain the json data for the route
var routeLineLayer; //Dynamic vector layer
var routeLine; //The dynamic route line
var routeLineStyle; //Style for the line
var routeLineWidth = 4; //Route line width
var routeLineStrokeWidth = 1; //Route line stroke width
var routeLineFillColorR = 0; //Route line fill color : red
var routeLineFillColorG = 191; //Route line fill color : green
var routeLineFillColorB = 255; //Route line fill color : blue
var routeLineFillColorA = 100; //Route line fill color : alpha
var routeLineStrokeColorR = 0; //Route line outline color : red
var routeLineStrokeColorG = 0; //Route line outline color : green
var routeLineStrokeColorB = 0; //Route line outline color : blue

//How far away from a line segment a mouse click will register a hit
var routeLineSegmentHitTestPixelBufferDistance = 10;

//How far away from a line vertex a mouse click will register a hit
var routeVertexHitTestPixelBufferDistance = 10;

//////////////////////////////////////////////////////////////////
//Map layer creation and utility functions for this sceario
//Creates a dynamic vector layer for the route line
function createAndAddDynamicVectorLayer(layerName, zOrder){
    var vectorLayer = new AltusUnified.DynamicVectorMap(layerName);
    vectorLayer.setOrder(zOrder);
    vectorLayer.setVectorWindingOrder(AltusUnified.VectorWindingOrder.BOTH);
    vectorLayer.setTesselationThreshold(40000);
    return vectorLayer;
}

//Adds a dynamic line to a dynamic vector layer
function addDynamicLine(vectorLayer, lineName, lineData, lineStyle){

    //Create line
    var dynamicLine = new AltusUnified.DynamicLine(lineName);

    //Create and add way point positions
    for(i=0; i&lt;lineData.length; i++){
        position2D = new AltusUnified.GeographicPosition2D(lineData[i].y, lineData[i].x);
        dynamicLine.points().push_back(position2D);
        position2D.delete();
    }

    //Add the line
    vectorLayer.addDynamicLine(dynamicLine, lineStyle);
    return dynamicLine;
}

//Creates a very accurate screen point in the same pixel coordinate space as the mapping engine.
//This is used by the mousedown event handler
function createScreenPoint(x, y){
    var percentagePoint = AltusUnified.scene.screen().getPercentagePoint(x, y);
    var screenPoint = AltusUnified.scene.screen().getScreenPoint(percentagePoint);
    percentagePoint.delete();
    return screenPoint;
}

//Given a mouse event, returns the closest geographic position.
function createNearestGeographicPosition(x, y){
    var screenSpacePercentagePoint = AltusUnified.scene.screen().getPercentagePoint(x, y);
    var ray = AltusUnified.scene.camera().getRay(screenSpacePercentagePoint);
    var worldPosition = AltusUnified.scene.camera().transform.worldPosition();

    var closestPointToSphere = AltusUnified.intersectRayWithUnitSphereOrClosestPoint(worldPosition, ray);

    //If we are in space, move to point on earth
    closestPointToSphere.normalize();

    //Create a position (must be deleted later)
    var geographicPosition = AltusUnified.getGeographicPosition(closestPointToSphere);

    //Clean up
    screenSpacePercentagePoint.delete();
    ray.delete();
    worldPosition.delete();
    closestPointToSphere.delete();

    return geographicPosition;
}

//Handles when a line segment is hit
function handleLineSegmentHit(lineSegmentHit, lon, lat) {
    pointWasMoved = false;
    var startPointIndex = lineSegmentHit.startPointIndex;

    //Insert a new entry into the route data for the new point that
    //will break the segment into 2 segments
    routeData.splice(
        startPointIndex+1, 0,{
            &quot;m&quot;: &quot;Foo&quot;,
            &quot;x&quot;: lon,
            &quot;y&quot;: lat,
            &quot;w&quot;: 9,
            &quot;ml&quot;: 3
        }
    );

    //set moving point index here
    movingPointIndex = startPointIndex+1;
}

//Handles when a line vertex is hit
function handleVertexHit(vertexHit){
    var vertexIndex = vertexHit.vertexIndex;
    movingPointIndex = vertexIndex;
}


//////////////////////////////////////////////////////////
//Labels

//Adds a clustered marker layer of labels nice fonts (see altusutil.js)
function addLabelLayer(){
    addMarkerLayer(labelLayerName, fontSize, maxLevel, clusterDistance, routeData);
}

//Updates the label layer by removing and re-adding the clustered markers
function updateLabelLayer(){
    var map = AltusUnified.scene.findMap(labelLayerName);
    if (map != null) {
        AltusUnified.scene.removeMap(map, true);
        map.delete();
    }
    addLabelLayer();
}

////////////////////////////////////////////////////////////////
//Mouse event handling

//Redraws the route line (called whenever routeData is changed)
function redrawRoute(){
    //Remove the current route line and delete
    routeLineLayer.removeDynamicLineFromCache(routeLine);
    routeLine.delete();

    //Add a new route line to the dynamic vector layer for the route
    routeLine = addDynamicLine(routeLineLayer, &quot;route&quot;, routeData, routeLineStyle);

    //Redraw the dynamic vector map
    routeLineLayer.rebuildMapUsingCachedShapes();
}

var PathMover = AltusUnified.ILongPressDelegate.extend(&quot;ILongPressDelegate&quot;, {
    withholdingInput: function () {},
    stoppedWitholdingInput: function () {},
    startLongPress: function (x, y) {
        // we have pressed for long enough
        var geographicPosition = createNearestGeographicPosition(x, y);
        mouseDownLat = geographicPosition.latitude;
        mouseDownLon = geographicPosition.longitude;
        geographicPosition.delete();
        console.log(&quot;mouse down at lon:&quot; + mouseDownLon + &quot; lat:&quot; + mouseDownLat);

        //Trigger hit
        var point = createScreenPoint(x, y);
        var hit = routeLineLayer.triggerLineHitDetection(point, 20, 20);
        point.delete();

        //Handle hit
        if (hit != null) {
            //Hit a vertex? (actual route waypoint)
            if (hit.hitType == AltusUnified.VectorGeometryHitType.Vertex) {
                handleVertexHit(hit);
            }
            //Hit a segment? (line between two route waypoints)
            if (hit.hitType == AltusUnified.VectorGeometryHitType.LineSegment) {
                handleLineSegmentHit(hit, mouseDownLon, mouseDownLat);
            }
            hit.delete();
            return true;
        }
        return false;
    },
    updateLongPress: function (x, y) {
        if (true) {
            pointWasMoved = true;
            //Get geographic position
            var geographicPosition = createNearestGeographicPosition(x, y);
            var mouseMoveLat = geographicPosition.latitude;
            var mouseMoveLon = geographicPosition.longitude;
            geographicPosition.delete();

            //Update the waypoint's metadata (label) to show the lat/lon
            //of it's new location
            routeData[movingPointIndex].y = mouseMoveLat;
            routeData[movingPointIndex].x = mouseMoveLon;
            routeData[movingPointIndex].m = &quot;&quot; + mouseMoveLat.toFixed(2) + &quot;,&quot; + mouseMoveLon.toFixed(2);

            redrawRoute();
        }
    },
    stoppedLongPress: function () {
        console.log(&quot;mouse up&quot;);

        if (pointWasMoved) {
            //Redraw labels only (as route is redrawn during mousemove event)
            updateLabelLayer();
        }

        if (!pointWasMoved) {
            //The new point was never actually moved, so delete it
            //Remove the new point and redraw the route
            routeData.splice(movingPointIndex, 1);
            redrawRoute();
        }
    }
});


///////////////////////////////////////////////////
//Route data acquisition
//Downloads route data in the background, when it is loaded, create a marker layer and a line to represent the route and then register to handle mouse events.
function loadRouteFromJSON(jsonFile){
    console.log(&quot;foo&quot;);
    downloadAndParseJSON(jsonFile,
        function(data){
            routeData = data;

            //Add marker layer
            addLabelLayer();

            //Add route line
            routeLine = addDynamicLine(routeLineLayer, &quot;route&quot;, routeData, routeLineStyle);
        },
        //Handle errors
        function(xhr) {
            console.log(&quot;Error downloading JSON data: &quot; + xhr.err)
        }
    );
}

//Handles hit events (when mouse comes up) for lines and shapes
var RouteLayerDelegate = AltusUnified.IVectorMapDelegate.extend(&quot;IVectorMapDelegate&quot;, {
    onLineSegmentHit: function (mapName, shapeId, geoHitPoint, screenPoint, segmentStartIndex, segmentEndIndex) {
            console.log(&quot;OnLineSegmentHit: &quot; + mapName + &quot;.&quot; + shapeId + &quot;(&quot; + segmentStartIndex + &quot;,&quot; + segmentEndIndex + &quot;) at &quot; + screenPoint);
    },
    onVertexHit: function (mapName, shapeId, geoHitPoint, screenPoint, vertexIndex) {
            console.log(&quot;OnVertexHit: &quot; + mapName + &quot;.&quot; + shapeId + &quot;(&quot; + vertexIndex + &quot;) at &quot; + screenPoint);
    },
    onPolygonHit: function (hits, geoHitPoint, screenPoint) {
        for (i = 0; i &lt; hits.size() ; i++)
        {
        var hit = hits.get(i);
        console.log(&quot;OnPolygonHit: &quot; + hit.mapName + &quot;.&quot; + hit.shapeId + &quot; at &quot; + screenPoint);
        hit.delete();
        }
        this.map.triggerLineHitDetection(screenPoint, 15, 15);
    },
    onPolygonHit3d: function (hits, screenPoint) {
        for (i = 0; i &lt; hits.size() ; i++)
        {
        var hit = hits.get(i);
        console.log(&quot;OnPolygonHit3d: &quot; + hit.mapName + &quot;.&quot; + hit.shapeId + &quot; at &quot; + screenPoint);
        hit.delete();
        }
    },
    polygonHitDetectionEnabled: function() {
        return true;
    },
    lineSegmentHitTestPixelBufferDistance: function() {
        return routeLineSegmentHitTestPixelBufferDistance;
    },
    vertexHitTestPixelBufferDistance: function() {
        return routeVertexHitTestPixelBufferDistance;
    },
    scene: null,
    map: null,
});

//Creates the style for the route line
function createRouteLineStyle(){

    var fillColor = new AltusUnified.Color(routeLineFillColorR,
                                           routeLineFillColorG,
                                           routeLineFillColorB,
                                           routeLineFillColorA);

    var strokeColor = new AltusUnified.Color(routeLineStrokeColorR,
                                             routeLineStrokeColorG,
                                             routeLineStrokeColorB);

    var style = new AltusUnified.LineStyle(fillColor, routeLineWidth,
                                           strokeColor, routeLineStrokeWidth);

    //Clean up
    fillColor.delete();
    strokeColor.delete();
    return style;
}

function routePlanning2DMain(){
    //Turn on a base map. This map is a set of weathergrid tiles
    //that look like terrain. They are smoothe bilinear filtered,
    //and are colored well for labels and things
    setColorbarTerrainBaseMap1(); //See altusutil.js

    //Create and add route layer
    routeLineLayer = createAndAddDynamicVectorLayer(&quot;routeLineLayer&quot;, 10);

    //Register a delegate for mouse clicks.
    //NOTE: You must register the delegate before adding this map layer
    var routeLayerDelegate = new RouteLayerDelegate();
    routeLineLayer.setDelegate(routeLayerDelegate);
    routeLayerDelegate.scene = AltusUnified.scene;
    routeLayerDelegate.map = routeLineLayer;
    routeLayerDelegate.delete();

    var prevInputHandler = AltusUnified.inputManager.rawInputHandler();
    var pathMoverDelegate = new PathMover();
    var longPressInputHandler = new AltusUnified.LongPressInputHandler(AltusUnified.scene, pathMoverDelegate, prevInputHandler);
    longPressInputHandler.setLongPressDuration(0);
    AltusUnified.inputManager.setRawInputHandler(longPressInputHandler);

    //Clean up
    pathMoverDelegate.delete();
    prevInputHandler.delete();
    longPressInputHandler.delete();

    //Add the map layer
    AltusUnified.scene.addMap(routeLineLayer);

    //Create style for route line
    routeLineStyle = createRouteLineStyle();

    //Load the initial route from a JSON file
    //This will download asyncrhonously (for example if you have a
    //large route or this data might be coming from a server)
    //When it completes it will add the route line and label layers
    loadRouteFromJSON(&quot;RouteMarkers.json&quot;);

    //Here you could put up a loading message...
}
</code></pre>


            </div>
        </div>
        <hr>
        <p align="right">AltusMappingEngine Web v2.0.ut.2153.g60764257e master</p>
        <p align="right">COPYRIGHT (C) 2017, BA3, LLC ALL RIGHTS RESERVED</p>
    </div>


    <script src="js/contents.js"></script>
    <script src="js/sidebar.js"></script>
    <script src="js/prism.js"></script>

<script>
<!--
//Activate the current side bar list item
document.getElementById('RoutePlanning2D').className="active";
//Activate the current OS in the top nav bar
document.getElementById('Web').className="active";
-->
</script>


</body>
</html>
